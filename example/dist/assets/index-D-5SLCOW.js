var f=Object.defineProperty;var p=(n,e,t)=>e in n?f(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>(p(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const w="/assets/Tarball.worker-CVLA3Ic6.js";class u{constructor(e,t={}){r(this,"fileInfo",[]);r(this,"buffer");r(this,"options");r(this,"worker");r(this,"resolve",[]);r(this,"defaultOptions",{useWorker:!0});this.buffer=e,this.options={...this.defaultOptions,...t};let s=0;for(;s<this.buffer.byteLength-512;){const i=this.readFileName(s);if(i.length==0)break;const o=this.readFileSize(s);this.fileInfo.push({name:i,size:o,header_offset:s}),s+=512+512*Math.trunc(o/512),o%512&&(s+=512)}}readFileName(e){const t=new Uint8Array(this.buffer,e,100),s=t.indexOf(0);return new TextDecoder().decode(t.slice(0,s))}readFileSize(e){const t=new Uint8Array(this.buffer,e+124,12);let s="";for(let i=0;i<11;i++)s+=String.fromCharCode(t[i]);return parseInt(s,8)}getInfo(e){return this.fileInfo.find(t=>t.name==e)}getBlob(e,t=""){const s=this.getInfo(e);if(s){const i=new Uint8Array(this.buffer,s.header_offset+512,s.size);return new Blob([i],{type:t})}}getImage(e,t){return this.options.useWorker?(this.worker||(this.worker=this.createWorker()),new Promise((s,i)=>{const o=this.getInfo(e);o&&!this.resolve[t]?(this.resolve[t]=s,this.worker.postMessage({cmd:"load",offset:o.header_offset+512,size:o.size,index:t})):i()})):new Promise((s,i)=>{const o=this.getBlob(e,"image");o!==void 0?createImageBitmap(o).then(a=>{s(a)}).catch(()=>{i()}):i()})}createWorker(){const e=new Worker(w);return e.addEventListener("message",t=>{const s=this.resolve[t.data.index];this.resolve[t.data.index]=void 0,s?s(t.data.imageBitmap):t.data.imageBitmap.close()}),e.postMessage({cmd:"init",buffer:this.buffer},[this.buffer]),e}}class v{constructor(e,t){r(this,"index");r(this,"highRes");r(this,"priority",0);r(this,"tarImageAvailable",!1);r(this,"loading",!1);r(this,"context");r(this,"_lowRes");r(this,"loadingLowRes",!1);this.index=t,this.context=e}async getImage(){return new Promise(async(e,t)=>{this.highRes!==void 0?e(this.highRes):this.lowRes!==void 0?e(this.lowRes):this.fetchLowRes().then(s=>e(s)).catch(()=>t())})}loadImage(e,t){return new Promise((s,i)=>{e.onload=()=>s(e),e.onerror=o=>i(o),e.src=t})}get lowRes(){if(this._lowRes!==void 0&&!this.loadingLowRes)return this._lowRes}async fetchLowRes(){return new Promise((e,t)=>{this.lowRes!==void 0?e(this.lowRes):this.tarImageAvailable&&!this.loadingLowRes?(this.loadingLowRes=!0,this.context.tarball.getImage(this.tarImageURL,this.index).then(s=>{this._lowRes=s,this.loadingLowRes=!1,e(s)}).catch(()=>{this.loadingLowRes=!1,t()})):t()})}releaseHighRes(){this.highRes&&(this.highRes.close(),this.highRes=void 0)}releaseLowRes(){this.lowRes&&(this.lowRes instanceof ImageBitmap&&this.lowRes.close(),this._lowRes=void 0,this.loadingLowRes=!1)}get tarImageURL(){if(this.context.options.tarImageURLCallback)return this.context.options.tarImageURLCallback(this.index)}get imageURL(){if(this.context.options.imageURLCallback)return new URL(this.context.options.imageURLCallback(this.index),window.location.href).href}}const R="/assets/ImageFetchWorker.worker-DNo6BPyV.js";class b{constructor(){r(this,"index",-1e10);r(this,"worker");r(this,"resolve");const e=new Worker(R);e.addEventListener("message",t=>{this.resolve&&t.data.index===this.index?this.resolve(t.data.imageBitmap):t.data.imageBitmap.close()}),this.worker=e}load(e,t){return this.index=e,new Promise((s,i)=>{this.resolve=s,this.worker.postMessage({cmd:"load",url:t,index:e})})}abort(){this.index=-1e10,this.resolve=void 0}}const d=class d{constructor(e,t){r(this,"canvas");r(this,"options");r(this,"width",0);r(this,"height",0);r(this,"frame",0);r(this,"ready");r(this,"tarball");r(this,"context");r(this,"tickFuncs",[]);r(this,"frames",[]);r(this,"startTime",-1);r(this,"animationRequestId",0);r(this,"container");r(this,"resizeObserver");r(this,"clearCanvas",!0);r(this,"maxLoading",6);r(this,"workerPool",[]);r(this,"speed",0);r(this,"prevFrame",0);r(this,"direction",1);r(this,"lastFrameDrawn",-1);if(this.options={...d.defaultOptions,...t},this.options.frames<=0)throw new Error("FastImageSequence: frames must be greater than 0");this.container=e,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.fillStyle=this.options.fillStyle,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.style.width="100%",this.canvas.style.height="100%",this.container.appendChild(this.canvas),this.resizeObserver=new ResizeObserver(()=>{this.clearCanvas=!0}),this.resizeObserver.observe(e);for(let s=0;s<this.options.frames;s++)this.frames.push(new v(this,s));this.ready=new Promise(async(s,i)=>{if(this.options.tarURL!==void 0){const o=await(await(await fetch(this.options.tarURL)).blob()).arrayBuffer();this.tarball=new u(o,{useWorker:this.options.useWorkerForTar}),this.frames.forEach(a=>{var h;return a.tarImageAvailable=a.tarImageURL!==void 0&&((h=this.tarball)==null?void 0:h.getInfo(a.tarImageURL))!==void 0}),this.options.preloadAllTarImages&&await Promise.all(this.frames.map(a=>a.fetchLowRes()))}s()}),this.drawingLoop(-1)}tick(e){this.tickFuncs.push(e)}play(e=30){this.speed=e}stop(){this.speed=0}get isPlaying(){return this.speed!==0}get isPaused(){return!this.isPlaying}get progress(){return this.index/(this.options.frames-1)}set progress(e){this.frame=(this.options.frames-1)*e}getFrameImage(e){return this.frames[this.wrapIndex(e)].getImage()}getWorker(){return this.workerPool.length===0&&this.workerPool.push(new b),this.workerPool.shift()}releaseWorker(e){e.abort(),this.workerPool.push(e)}get index(){return this.wrapIndex(this.frame)}wrapIndex(e){const t=e|0;return this.wrapFrame(t)}wrapFrame(e){return this.options.wrap?(e%this.options.frames+this.options.frames)%this.options.frames:Math.max(Math.min(e,this.options.frames-1),0)}async drawingLoop(e=0){e/=1e3;const t=this.startTime<0?1/60:Math.min(e-this.startTime,1/30);this.startTime=e>0?e:-1,this.frame-this.prevFrame<0&&(this.direction=-1),this.frame-this.prevFrame>0&&(this.direction=1),this.frame+=this.speed*t,this.frame=this.wrapFrame(this.frame);let s=this.index;this.frames[s].getImage().then(i=>{this.drawFrame(i,s)}).catch(()=>{}),this.load(t),this.prevFrame=this.frame,this.tickFuncs.forEach(i=>i(t)),this.animationRequestId=window.requestAnimationFrame(i=>this.drawingLoop(i))}drawFrame(e,t){if(Math.abs(this.lastFrameDrawn-this.index)<Math.abs(t-this.index))return;this.lastFrameDrawn=t;const s=this.container.offsetWidth/this.container.offsetHeight,i=e.width/e.height;if(this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height),this.options.size==="contain"){const h=s>i?this.height*s:this.width,c=s>i?this.height:this.width/s;(this.canvas.width!==h||this.canvas.height!==this.height)&&(this.canvas.width=h,this.canvas.height=c)}else{const h=s>i?this.width:this.height*s,c=s>i?this.width/s:this.height;(this.canvas.width!==h||this.canvas.height!==this.height)&&(this.canvas.width=h,this.canvas.height=c)}const o=(this.canvas.width-this.width)/2,a=(this.canvas.height-this.height)/2;(this.clearCanvas||this.options.clearCanvas)&&(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.clearCanvas=!1),this.context.drawImage(e,0,0,e.width,e.height,o,a,this.width,this.height)}load(e){this.index;const t=this.index;this.frames.forEach(a=>{a.priority=Math.abs(a.index-t),this.options.wrap&&(a.priority=Math.min(a.priority,this.options.frames-a.priority))});let s=this.frames.filter(a=>a.loading).length;const i=this.maxLoading;this.frames.filter(a=>a.highRes!==void 0&&!a.loading&&a.priority>this.spread).forEach(a=>{a.releaseHighRes(),this.options.preloadAllTarImages||a.releaseLowRes()});const o=this.frames.filter(a=>a.highRes===void 0&&!a.loading&&a.priority<=this.spread).sort((a,h)=>a.priority-h.priority);for(;s<i&&o.length>0;){const a=o.shift(),h=a.index;if(a.imageURL!==void 0){a.loading=!0;const c=this.getWorker();c.load(h,a.imageURL).then(g=>{a.releaseHighRes(),a.highRes=g,a.loading=!1,this.releaseWorker(c)})}s++}}get spread(){return this.options.wrap?Math.floor(this.options.numberOfCachedImages/2):this.options.numberOfCachedImages}destruct(){cancelAnimationFrame(this.animationRequestId),this.resizeObserver.disconnect(),this.container.removeChild(this.canvas),this.canvas.replaceWith(this.canvas.cloneNode(!0))}};r(d,"defaultOptions",{frames:1,imageURLCallback:void 0,tarURL:void 0,tarImageURLCallback:void 0,wrap:!1,fillStyle:"#00000000",size:"cover",preloadAllTarImages:!1,clearCanvas:!1,useWorkerForTar:!0,numberOfCachedImages:32});let m=d;const y=document.getElementsByClassName("container")[0],L=document.getElementById("prev-button"),x=document.getElementById("next-button"),l=document.getElementById("slider-input");async function I(){const n=new m(y,{frames:425,wrap:!1,imageURLCallback:e=>`./public/getty_persepolis_WebGL_intro_comp_v010.1${(""+(e+1)).padStart(3,"0")}.avif`,tarURL:"./public/lowres.tar",tarImageURLCallback:e=>`getty_persepolis_WebGL_intro_comp_v010.1${(""+(e+1)).padStart(3,"0")}.avif`});await n.ready,document.getElementsByClassName("loading")[0].remove(),n.progress=0,n.tick(e=>{n.isPlaying&&(l.value=n.progress)}),L.addEventListener("click",()=>{n.play(-30)}),x.addEventListener("click",()=>{n.play(30)}),l.addEventListener("mousedown",e=>{n.stop()}),l.addEventListener("input",()=>{n.isPaused&&(n.progress=l.value)}),n.play(30),console.log(n)}I();
